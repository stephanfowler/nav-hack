<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">

<html>
<head>
    <title>Nav test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/javascript" src="./js/knockout.js"></script>
    <style>
        .nav{
            position: relative;
            font-size: 16px;
            font-family: Georgia;
            text-transform: capitalize;
        }
        .section {
            border-bottom: 1px solid #eeeeee;
            padding: 0 0 5px;
            white-space: nowrap;
            overflow: hidden;
        }
        .expanded .section{
            white-space: inherit;
        }
        .all,
        .section a {
            display: inline-block;
            padding: 2px 5px 0 5px;
            height: 22px;
            margin: 0 2px 0 0;
            cursor: pointer;
            color: #333333;
            text-decoration: none;
        }
        .section a.selected {
            padding: 3px 5px 0 5px;
        }
        a.section__name {
            font-weight: bold;
            color: #005689;
        }
        .ellipsis {
            position: absolute;
            top: 1px;
            right: -5px;
            background-color: #ffffff;
            font-weight: bold;
            font-size: 28px;
            color: #005689;
            line-height: 10px;
            z-index: 2;
            padding: 0 7px 0 7px;
            box-shadow: -5px 0 6px -3px #CCCCCC;
            height: 23px;
            border-left: 1px solid #dddddd;
        }
        .all {
            height: 25px;
            color: #005689;
        }
        .tree {
            max-height: 25px;
            overflow: hidden;
            left: 34px;
        }
        /*
            left: 28px;
        */
        .expanded {
            max-height: inherit;
        }
        a.selected {
            color: #ffffff;
            background: #005689;
        }
    </style>
</head>

<body>

<div class="nav">
    <a class="all" data-bind="
        click: toggleExpanded">All Sections</a>
    &middot;
    <a class="all">Search</a>
</div>

<div class="nav">
    <div class="ellipsis" data-bind="
        click: toggleExpandedSub">...</div>

    <div class="tree" data-bind="
        css: {expanded: expanded() || expandedSub()},
        foreach: sections">

        <div class="section" data-bind="
            visible: $index() === 0 || $root.expanded()">
            <a class="section__name" data-bind="
                css: {selected: selected},
                attr: {href: href},
                text: name"></a
            ><span class="subs" data-bind="foreach: subs"
                ><a class="subs__item" data-bind="
                    css: {selected: selected},
                    attr: {href: href},
                    text: name"></a></span>
        </div>
    </div>
</div>

<script>
    var pos = queryArgs(),
        model = {},
        tree =  [
        { "name": "UK", "subs": []},
        { "name": "world", "subs": [{"name":"europe"},{"name":"US"},{"name":"americas"},{"name":"asia"},{"name":"australia"},{"name":"africa"},{"name":"middle east"}]},
        { "name": "sport", "subs": [{"name":"football"},{"name":"world cup"},{"name":"rugby union"},{"name":"rugby league"},{"name":"cricket"},{"name":"tennis"},{"name":"cycling"},{"name":"boxing"},{"name":"US sports"},{"name":"formula one"}]},
        { "name": "football", "subs": [{"name":"world cup"},{"name":"live scores"},{"name":"tables"},{"name":"competitions"},{"name":"results"},{"name":"fixtures"},{"name":"clubs"}]},
        { "name": "comment", "subs": []},
        { "name": "culture", "subs": [{"name":"film"},{"name":"tv & radio"},{"name":"music"},{"name":"books"},{"name":"art & design"},{"name":"stage"}]},
        { "name": "economy", "subs": [{"name":"markets"},{"name":"companies"},{"name":"media"}]},
        { "name": "life", "subs": [{"name":"food"},{"name":"health"},{"name":"love & sex"},{"name":"family"},{"name":"women"},{"name":"home & garden"}]},
        { "name": "environment", "subs": [{"name":"cities"},{"name":"development"}]},
        { "name": "tech", "subs": [{"name":"games"}]},
        { "name": "money", "subs": [{"name":"property"},{"name":"savings"},{"name":"borrowing"},{"name":"careers"}]},
        { "name": "travel", "subs": [{"name":"UK"},{"name":"europe"},{"name":"US"}]},
        { "name": "fashion", "subs": []},
        { "name": "science", "subs": []},
        { "name": "education", "subs": []}];


    model.sections = ko.observableArray(
        spin(
            tree.map(function(s) { return new Section(s, pos); }),
            function(s) { return s.selected(); }
        )
    );

    model.expanded = ko.observable(false);

    model.expandedSub = ko.observable(false);

    model.toggleExpanded = function() {
        model.expanded(!model.expanded());
        model.expandedSub(false);
    };

    model.toggleExpandedSub = function() {
        if (model.expanded()) {
            model.expandedSub(false);
        } else {
            model.expandedSub(!model.expandedSub());    
        }
        model.expanded(false);
    };

    function Section(opts, pos) {
        var self = this;

        this.name = opts.name;        

        this.href = makeHref(opts.name);

        this.selected = ko.observable(opts.name === pos.section);

        this.subs = ko.observableArray(
            spin(
                opts.subs.map(function(s) {return new Sub(s, pos, self)}),
                function(s) { return s.selected(); }
            )
        );
    };

    function Sub(opts, pos, parent) {
        var self = this;

        this.name = opts.name;

        this.href = makeHref(parent.name, opts.name);

        this.selected = ko.observable(opts.name === pos.sub);
    };

    function makeHref(section, sub) {
        return '?' + 
            (section ? 'section=' + encodeURIComponent(section)  + '&' : '') + 
            (sub ? 'sub=' + encodeURIComponent(sub) : '');
    };

    function queryArgs() {
        var obj = {};
        window.location.search.substring(1).split('&').forEach(function(kv) {
            obj[kv.split('=')[0]] = kv.split('=')[1] === undefined ? '' : decodeURIComponent(kv.split(/=(.+)?/)[1]);
        });
        return obj;
    };

    function spin(arr, predicate) {
        var halfs = arr.reduce(function(acc, o) {
                acc.found = acc.found || predicate(o);
                acc[acc.found ? 'top' : 'tail'].push(o);
                return acc;
            }, {top: [], tail: [], found: false});

        return halfs.top.concat(halfs.tail);
    };

    console.log(pos);

    ko.applyBindings(model);
</script>

</body>
</html>
