<!DOCTYPE html>
<html>
<head>
    <title>Nav test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/javascript" src="./js/knockout.js"></script>
    <style>
        .nav {
            position: relative;
            font-size: 18px;
            font-family: Georgia;
            color: #333333;
        }
        .nav--top {
            height: 30px;
        }
        .sections_other {
            display: inline-block;
            border-left: 1px solid #dddddd;
            box-shadow: -5px 0 6px -4px #CCCCCC;
            height: 27px;
        }
        .section {
            border-bottom: 1px solid #eeeeee;
            padding: 0 0 5px;
            white-space: nowrap;
            overflow: hidden;
        }
        .expanded .section {
            white-space: inherit;
        }
        .section a {
            display: inline-block;
            padding: 2px 5px 3px 5px;
            height: 22px;
            cursor: pointer;
            color: #333333;
            text-decoration: none;
        }
        a.section__name {
            font-weight: bold;
            color: #005689;
            margin: 0 5px 0 0;
        }
        .ellipsis {
            position: absolute;
            top: 0px;
            right: -5px;
            background-color: #ffffff;
            font-weight: bold;
            font-size: 28px;
            color: #005689;
            line-height: 12px;
            z-index: 2;
            padding: 0 7px 0 7px;
            box-shadow: -5px 0 6px -4px #CCCCCC;
            height: 27px;
            border-left: 1px solid #dddddd;
            cursor: pointer;
        }
        .all {
            cursor: pointer;
            height: 25px;
            color: #005689;
            font-weight: bold;
        }
        a.selected {
            color: #ffffff;
            background: #005689;
        }
    </style>
</head>
<body>
<div align="right"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzAiIHdpZHRoPSIxNjAiPjxwYXRoIGQ9Ik0yLjMwMSAxMS4yM2gtMi4zMDF2LTIuMTQzbDIuMzAxLS4zMDV2LTIuNjc5bDQuOTc1LS42NjN2My4zNDJoMy4yNjJ2Mi40NDloLTMuMjYzdjcuNTI1YzAgMS40MDIuNDAzIDIuMTE2IDEuODQ1IDIuMTE2LjUzNSAwIDEuMjMtLjA1MSAxLjYwNC0uMTAxdjEuODM2Yy0uODI5LjQ1OS0yLjUxMy44NDMtNC4wNjQuODQzLTIuOTY5IDAtNC4zNi0xLjI1MS00LjM2LTQuMjg1di03LjkzNnptOC42ODcgMTAuNTM1bDEuNjMyLS43MTV2LTE1Ljc4OGwtMS43MTEtLjczOXYtMS4yNDlsNi4yMDYtLjk0NWguNDAxdjcuOTU4aC4xNmMxLjMzNy0xLjE3MyAzLjE1NS0xLjg2MSA1LjE4OS0xLjg2MSAyLjQ4NyAwIDMuNzQ1IDEuMTczIDMuNzQ1IDMuODAxdjguODI0bDEuNjMyLjcxNXYxLjNoLTguMTg1di0xLjNsMS41NzctLjcxNXYtNy43NTRjMC0xLjQ3OS0uNjQyLTIuMDE0LTIuMDA1LTIuMDE0LS43NSAwLTEuNDE5LjE1My0yLjAzNC4zODJ2OS4zODZsMS41NzcuNzE1djEuM2gtOC4xODV2LTEuM3ptMjIuOTE1LTUuNDA5Yy4yNDEgMi43ODEgMS42MzIgNC4xMDUgNC4zNiA0LjEwNSAxLjkgMCAyLjk2OS0uMTc4IDQuMDEyLS40ODR2MS4zNzhjLS42OTUuOTE3LTIuOTQxIDIuMDkyLTUuNjk3IDIuMDkyLTUuMTM1IDAtNy43ODItMi43MDQtNy43ODItNy41NSAwLTQuNzE5IDIuOTE0LTcuNDQ4IDcuMzgxLTcuNDQ4IDQuNDkzIDAgNi42NTkgMS45MTQgNi42NTkgNy45MDdoLTguOTMzem0tLjA1My0xLjcwOGw0LjE0Ni0uMjI5YzAtMy44MDEtLjY2OC00LjQxMy0xLjg5OC00LjQxMy0xLjM2NCAwLTIuMTk0Ljg0MS0yLjI0NyA0LjY0MnoiIGZpbGw9IiM5NGIxY2EiLz48cGF0aCBkPSJNNTguMzcgMjQuMDM0YzAgMy4zOTMtMi41NCA1LjUzNS04LjM5NyA1LjUzNS00LjcwNyAwLTcuNTk1LTEuNDA0LTcuNTk1LTMuMzE2IDAtMS44NjEgMS44OTgtMi4zOTcgMy41ODMtMi43M3YtLjE1M2MtMS42MDQtLjMzLTIuMzgxLTEuNDI4LTIuMzgxLTIuNTUxIDAtMS41MDQgMS42NTgtMi43MDMgMi41MTMtMy4yNjV2LS4xNTJjLTEuNDk3LS43OTItMi40ODctMi4xOTQtMi40ODctNC4wODEgMC0zLjA4NyAyLjY3NC00LjkyNCA2LjUyNS00LjkyNCAxLjIwNSAwIDIuNTE1LjM1OCAzLjQ1MS42ODhoLjIxNGwzLjgyNS0uNzE0aC4yOTR2Mi44MzNoLS4zNDhsLTIuNDg4LS44NDN2LjEwMmMuOTM3LjgxNiAxLjU1MiAxLjYwNiAxLjU1MiAzLjAwOSAwIDMuMTEyLTIuNjQ4IDQuNzctNi41IDQuNzctLjk4OSAwLTEuNjU4LS4wNTEtMi40Ni0uMjc5LS4zNzQuMjU1LS42NjguNjYzLS42NjggMS4wNDQgMCAuNTEuNDgxLjkxOCAxLjA3MS45MThoNS4zNDljMy4zMTUuMDAzIDQuOTQ2IDEuMzA1IDQuOTQ2IDQuMTF6bS00LjMwNiAxLjMyNmMwLS43MzgtLjU2MS0xLjA5NS0xLjc5My0xLjA5NWgtNS4yNDFjLS40MDMuNDMzLS41ODguOTE3LS41ODggMS42MDYgMCAuOTk0LjkzNiAxLjkxNCAzLjY2NCAxLjkxNCAzLjEwMi0uMDAxIDMuOTU3LS45NDUgMy45NTctMi40MjV6bS01LjY5Ny0xMi4wMzhjMCAyLjkwOC42OTUgMy4xNjIgMS43NjUgMy4xNjIgMS4wNzEgMCAxLjc5My0uMzA2IDEuNzkzLTMuMTYycy0uNjk3LTMuMjkxLTEuNzkzLTMuMjkxYy0xLjA2OS0uMDAyLTEuNzY1LjM4Mi0xLjc2NSAzLjI5MXptMTEuNTc2LTEuODg3bC0xLjY4My0uNzQxdi0xLjMwMmw2LjIzMS0uOTQzaC40Mjh2MTAuMDc1YzAgMS42MzIuODI5IDEuOTE0IDIuMDg2IDEuOTE0LjgyOSAwIDEuMjgzLS4xMjcgMS43OTEtLjMzMXYtOC42NzFsLTEuNjU4LS43NDF2LTEuMzAybDYuMjMxLS45NDNoLjQwMXYxMi4yMThsMS42ODYuODQxdjEuMjI0bC02LjA3MS42MzdoLS40MDN2LTEuODg3aC0uMTg3Yy0uOTYzIDEuMTIyLTIuNTQyIDEuOTY1LTQuNTQ3IDEuOTY1LTMuMDIzIDAtNC4zMDYtMi4wNjctNC4zMDYtNC41NHYtNy40NzN6bTE5LjM4NSAxLjgxaC0yLjMyNnYtMy43MjRjMS40MTctLjQzNSAzLjEwMy0xLjA5NiA1LjcyNS0xLjA5NiA0LjAxMSAwIDYuNDE4IDEuMTIyIDYuNDE4IDQuMzM2djguMjlsMS41NzcuNzE1djEuMDcxYy0uNDgxLjI1NS0xLjYwNi41ODYtMi44MDkuNTg2LTEuNTUyIDAtMi45NDEtLjQ4NC0zLjE4My0yLjAxNGgtLjEzNWMtLjY2NyAxLjI3NC0yLjQzMyAyLjA0LTQuMzA1IDIuMDQtMi42NDcgMC00LjMwNS0xLjYzMi00LjMwNS00LjAwNSAwLTIuOTMyIDEuOTc5LTMuNTIgNS4yOTQtNC4wNTZsMi44NjItLjQ1OXYtMS45MTJjMC0xLjgxLS41NjEtMi43My0yLjQ4OC0yLjczLS4yNDEgMC0uOTYxLjAyNS0xLjI4My4wNTFsLTEuMDQzIDIuOTA3em00LjgxNCAzLjIxM2wtMS4xNS4xMDFjLTEuMTUuMTAyLTIuMDg2Ljg0My0yLjA4NiAyLjE5NCAwIDEuNTgxLjkwOSAyLjA5MiAxLjg3MyAyLjA5Mi41MzMgMCAxLjA5Ni0uMjU1IDEuMzY0LS41MzV2LTMuODUyem0xMi44MDctOC4wODZoLjQyOHYzLjAxaC4xNmMuODgyLTEuODg4IDIuMjE5LTIuOTA4IDMuODUyLTIuOTA4LjI2NyAwIC41ODguMDI1Ljc0OS4wNzZ2NC4xNThjLS4yOTQtLjA3Ni0uODMtLjEyNy0xLjI1OC0uMTI3LTEuMzM3IDAtMi40Ni4xMjctMy4zMTUuNTF2Ny45MzNsMi4wNi43MTR2MS4zMjdoLTguNjEydi0xLjMyN2wxLjU3Ny0uNzE0di05LjY2N2wtMS42NTktLjczOHYtMS4zMDNsNi4wMTktLjk0M3ptMTUuMDI2LTIuODA1bC0xLjY1OC0uNzE0di0xLjMwMmw2LjIzMS0uOTQzaC40MDN2MTguMDU5bDEuNTc4Ljg0MXYxLjIyNGwtNS45MS42MzdoLS40Mjh2LTEuNDc5aC0uMTYyYy0uNjE1Ljc2NS0xLjg5OCAxLjU1Ny0zLjc3IDEuNTU3LTIuNzI5IDAtNS45OTEtMS42NTktNS45OTEtNy4xNDIgMC01Ljc2NCAzLjM0Mi03LjgzIDcuMzAxLTcuODMuODMgMCAxLjc5MS4xNzggMi40MDYuNTg2di0zLjQ5NXptMCA1LjM4MmMtLjM3NC0uMjgtLjgwMi0uNTEtMS42ODQtLjUxLTEuNTc3IDAtMi43NTQgMS4zNTMtMi43NTQgNS4zODMgMCAzLjUxOS45MzYgNS4wNDkgMi45MTQgNS4wNDkuNzUgMCAxLjE3OC0uMTI3IDEuNTI0LS4yNTV2LTkuNjY3em0xMy4wMi0yLjU3N2guNDAxdjEyLjY1MmwxLjYwNi43MTR2MS4zMjdoLTguMTg1di0xLjMyN2wxLjYwNC0uNzE0di05LjY2N2wtMS42ODQtLjczOHYtMS4zMDNsNi4yNTgtLjk0M3ptLjQ4My0zLjM0YzAgMS4zNzctMS4yMDUgMi41LTIuNjQ4IDIuNS0xLjQ3MSAwLTIuNjQ3LTEuMTIzLTIuNjQ3LTIuNSAwLTEuNDAyIDEuMTc2LTIuNTI2IDIuNjQ3LTIuNTI2IDEuNDQ0IDAgMi42NDggMS4xMjMgMi42NDggMi41MjZ6bTUuNDI2IDguMjEzaC0yLjMyNnYtMy43MjRjMS40MTctLjQzNSAzLjEwMy0xLjA5NiA1LjcyNS0xLjA5NiA0LjAxMSAwIDYuNDE4IDEuMTIyIDYuNDE4IDQuMzM2djguMjlsMS41NzcuNzE1djEuMDcxYy0uNDgxLjI1NS0xLjYwNi41ODYtMi44MDkuNTg2LTEuNTUyIDAtMi45NDEtLjQ4NC0zLjE4My0yLjAxNGgtLjEzNWMtLjY2OCAxLjI3NC0yLjQzMyAyLjA0LTQuMzA1IDIuMDQtMi42NDcgMC00LjMwNS0xLjYzMi00LjMwNS00LjAwNSAwLTIuOTMyIDEuOTc5LTMuNTIgNS4yOTQtNC4wNTZsMi44NjItLjQ1OXYtMS45MTJjMC0xLjgxLS41NjEtMi43My0yLjQ4OC0yLjczLS4yNDEgMC0uOTYxLjAyNS0xLjI4My4wNTFsLTEuMDQzIDIuOTA3em00LjgxNCAzLjIxM2wtMS4xNS4xMDFjLTEuMTUuMTAyLTIuMDg2Ljg0My0yLjA4NiAyLjE5NCAwIDEuNTgxLjkwOSAyLjA5MiAxLjg3MyAyLjA5Mi41MzMgMCAxLjA5Ni0uMjU1IDEuMzY0LS41MzV2LTMuODUyem02Ljg2OSA1LjMwN2wxLjYzMi0uNzE1di05LjY5MmwtMS43MTEtLjczOHYtMS4yNTFsNi4yMDUtLjk0M2guNDAzdjEuODYxaC4xNTljMS4zMzctMS4xNzMgMy4xNTYtMS44NjEgNS4xODktMS44NjEgMi40ODggMCAzLjc0NSAxLjE3MyAzLjc0NSAzLjgwMXY4LjgyNGwxLjYzMi43MTV2MS4zaC04LjE4NXYtMS4zbDEuNTc3LS43MTV2LTcuNzU0YzAtMS40NzktLjY0My0yLjAxNC0yLjAwNy0yLjAxNC0uNzQ5IDAtMS40MTcuMTUzLTIuMDMyLjM4MnY5LjM4NmwxLjU3OC43MTV2MS4zaC04LjE4NXYtMS4zeiIgZmlsbD0iIzIxNDU4MyIvPjwvc3ZnPg=="></div>
<div class="nav nav--top">
    <a class="all" data-bind="
        click: expander">all sections</a> &middot; 
    <a class="">search</a> &middot;
    <a class="">etc</a>
</div>

<div class="nav">
    <div class="ellipsis" data-bind="
        click: expander">...</div>

    <div class="tree" data-bind="
        css: {expanded: expanded() || expandedSub()},
        foreach: sections">

        <!-- ko if: $index() === 0 || $root.expanded() -->
            <div class="section">
                <a class="section__name" data-bind="
                    css: {selected: selected},
                    attr: {href: href},
                    text: name"
                ></a
                ><span data-bind="foreach: subs"
                    ><a data-bind="
                        css: {selected: selected},
                        attr: {href: href},
                        text: name"
                    ></a
                ></span>

                <!-- ko if: $index() === 0 && !$root.expanded() -->
                    <span class="sections_other" data-bind="
                        foreach: $root.otherSections">
                        <a class="section__name" data-bind="
                            attr: {href: href},
                            text: name"
                        ></a>
                    </span>
                <!-- /ko -->


            </div>
        <!-- /ko -->
    </div>
</div>

<script>
    var model = {},
        pos = queryArgs({section: 'UK'}),
        tree = [
            { "name": "UK", "subs": []},
            { "name": "world", "subs": [{"name":"europe"},{"name":"US"},{"name":"americas"},{"name":"asia"},{"name":"australia"},{"name":"africa"},{"name":"middle east"}]},
            { "name": "sport", "subs": [{"name":"football"},{"name":"world cup"},{"name":"rugby union"},{"name":"rugby league"},{"name":"cricket"},{"name":"tennis"},{"name":"cycling"},{"name":"boxing"},{"name":"US sports"},{"name":"formula one"}]},
            { "name": "football", "subs": [{"name":"world cup"},{"name":"live scores"},{"name":"tables"},{"name":"competitions"},{"name":"results"},{"name":"fixtures"},{"name":"clubs"}]},
            { "name": "comment", "subs": []},
            { "name": "culture", "subs": [{"name":"film"},{"name":"tv & radio"},{"name":"music"},{"name":"books"},{"name":"art & design"},{"name":"stage"}]},
            { "name": "economy", "subs": [{"name":"markets"},{"name":"companies"},{"name":"media"}]},
            { "name": "life", "subs": [{"name":"food"},{"name":"health"},{"name":"love & sex"},{"name":"family"},{"name":"women"},{"name":"home & garden"}]},
            { "name": "environment", "subs": [{"name":"cities"},{"name":"development"}]},
            { "name": "tech", "subs": [{"name":"games"}]},
            { "name": "money", "subs": [{"name":"property"},{"name":"savings"},{"name":"borrowing"},{"name":"careers"}]},
            { "name": "travel", "subs": [{"name":"UK"},{"name":"europe"},{"name":"US"}]},
            { "name": "fashion", "subs": []},
            { "name": "science", "subs": []},
            { "name": "education", "subs": []}
        ];

    model.sections = ko.observableArray(
        hoist(
            tree.map(function(s) { return new Item(s, pos); }),
            function(s) { return s.selected(); }
        )
    );

    model.otherSections = ko.observableArray(
        tree
        .filter(function(s) { return s.name !== pos.section; })
        .map(function(s) { return new Item(s, pos); })
    );

    model.expanded = ko.observable(false);
    model.expander = function() {
        model.expanded(!model.expanded());
        model.expandedSub(false);
    };

    model.expandedSub = ko.observable(false);
    model.expanderSub = function() {
        if (model.expanded()) {
            model.expandedSub(false);
        } else {
            model.expandedSub(!model.expandedSub());    
        }
        model.expanded(false);
    };

    function Item(opts, pos, parent) {
        var self = this;

        opts = opts || {};
        pos = pos || {};

        this.name = opts.name;

        this.href = makeHref((parent || opts).name, parent ? opts.name : undefined);

        this.selected = ko.observable(parent ? (parent.selected() && opts.name === pos.sub) : (opts.name === pos.section));

        this.subs = opts.subs ? ko.observableArray(
            spin(
                opts.subs.map(function(s) {return new Item(s, pos, self)}),
                function(s) { return s.selected(); }
            )
        ) : undefined;
    };

    function makeHref(section, sub) {
        return '?section=' + encodeURIComponent(section)  + (sub ? '&sub=' + encodeURIComponent(sub) : '');
    };

    function queryArgs(defaults) {
        return window.location.search.substring(1).split('&').reduce(function(obj, kv) {
            var tuple = kv.split('=');

            obj[tuple[0]] = tuple[1] === undefined ? '' : decodeURIComponent(tuple[1]);
            return obj;
        }, defaults || {});
    };

    function hoist(arr, predicate) {
        var halfs = arr.reduce(function(acc, o) {
                acc[predicate(o) ? 'top' : 'tail'].push(o);
                return acc;
            }, {top: [], tail: []});

        return halfs.top.concat(halfs.tail);
    };

    function spin(arr, predicate) {
        var found,
            halfs = arr.reduce(function(acc, o) {
                found = found || predicate(o);
                acc[found ? 'top' : 'tail'].push(o);
                return acc;
            }, {top: [], tail: []});

        return halfs.top.concat(halfs.tail);
    };

    ko.applyBindings(model);
</script>

</body>
</html>
